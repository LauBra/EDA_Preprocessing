{
  "hash": "3a27343338387278650b1025605f91e3",
  "result": {
    "engine": "knitr",
    "markdown": "\n---\ntitle: \"Pima Preprocessing → Leak-free ML Pipeline (R)\"\nformat:\n  html:\n    toc: true\n    code-fold: true\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(tidymodels)\n\ntheme_set(theme_minimal())\nset.seed(123)\n```\n:::\n\n\n## 1. Data and goal\n\nWe will use the `PimaIndiansDiabetes2` dataset and focus on a **simple regression problem**:\n\n- **Outcome**: `pedigree` (diabetes pedigree function)  \n- **Predictors**: `age`, `glucose`  \n\nOur goal is to **compare two pipelines**:\n\n1. A **wrong** one, where we scale *before* splitting (data leakage).\n2. A **correct** one, where we scale using **training data only**.\n\nWe’ll use **MAE (Mean Absolute Error)** to compare test performance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"PimaIndiansDiabetes2\", package = \"mlbench\")\n\npima_small <- PimaIndiansDiabetes2 %>%\n  clean_names() %>%\n  select(age, glucose, pedigree) %>%\n  filter(!is.na(pedigree))  # outcome must be present\n\nhead(pima_small)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  age glucose pedigree\n1  50     148    0.627\n2  31      85    0.351\n3  32     183    0.672\n4  21      89    0.167\n5  33     137    2.288\n6  30     116    0.201\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(pima_small)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      age           glucose         pedigree     \n Min.   :21.00   Min.   : 44.0   Min.   :0.0780  \n 1st Qu.:24.00   1st Qu.: 99.0   1st Qu.:0.2437  \n Median :29.00   Median :117.0   Median :0.3725  \n Mean   :33.24   Mean   :121.7   Mean   :0.4719  \n 3rd Qu.:41.00   3rd Qu.:141.0   3rd Qu.:0.6262  \n Max.   :81.00   Max.   :199.0   Max.   :2.4200  \n                 NA's   :5                       \n```\n\n\n:::\n:::\n\n\n## 2. WRONG pipeline: scaling before train–test split (leakage)\n\n### 2.1. Compute global mean and sd (leaky)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_all_glucose <- mean(pima_small$glucose, na.rm = TRUE)\nsd_all_glucose   <- sd(pima_small$glucose, na.rm = TRUE)\n\nmean_all_age <- mean(pima_small$age, na.rm = TRUE)\nsd_all_age   <- sd(pima_small$age, na.rm = TRUE)\n\nmean_all_glucose; sd_all_glucose\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 121.6868\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 30.53564\n```\n\n\n:::\n\n```{.r .cell-code}\nmean_all_age; sd_all_age\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 33.24089\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 11.76023\n```\n\n\n:::\n:::\n\n\n### 2.2. Scale the full dataset using global statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\npima_small_scaled <- pima_small %>%\n  mutate(\n    glucose_scaled = (glucose - mean_all_glucose) / sd_all_glucose,\n    age_scaled     = (age - mean_all_age) / sd_all_age\n  )\n\nhead(pima_small_scaled)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  age glucose pedigree glucose_scaled  age_scaled\n1  50     148    0.627      0.8617221  1.42506672\n2  31      85    0.351     -1.2014407 -0.19054773\n3  32     183    0.672      2.0079237 -0.10551539\n4  21      89    0.167     -1.0704463 -1.04087112\n5  33     137    2.288      0.5014873 -0.02048305\n6  30     116    0.201     -0.1862336 -0.27558007\n```\n\n\n:::\n:::\n\n\n### 2.3. Train–test split on already scaled data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\ndata_split <- initial_split(pima_small_scaled, prop = 0.7)\n\ntrain <- training(data_split)\ntest  <- testing(data_split)\n\nnrow(train); nrow(test)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 537\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 231\n```\n\n\n:::\n:::\n\n\n### 2.4. Fit linear regression model and compute MAE (WRONG)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nped_model <- linear_reg() %>%\n  set_engine(\"lm\")\n\nfit_wrong <- ped_model %>%\n  fit(pedigree ~ age_scaled + glucose_scaled, data = train)\n\nresults_wrong <- predict(fit_wrong, new_data = test) %>%\n  bind_cols(test)\n\nmae_wrong <- mae(\n  data    = results_wrong,\n  truth   = pedigree,\n  estimate = .pred\n)\n\nmae_wrong\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 mae     standard       0.234\n```\n\n\n:::\n:::\n\n\n## 3. RIGHT pipeline: scaling using training data only (no leakage)\n\n### 3.1. Train–test split on the original data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\ndata_split_right <- initial_split(pima_small, prop = 0.8)\n\ntrain <- training(data_split_right)\ntest  <- testing(data_split_right)\n\nnrow(train); nrow(test)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 614\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 154\n```\n\n\n:::\n:::\n\n\n### 3.2. Compute training-only mean and sd\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmu_tr_glucose <- mean(train$glucose, na.rm = TRUE)\nsd_tr_glucose <- sd(train$glucose, na.rm = TRUE)\n\nmu_tr_age <- mean(train$age, na.rm = TRUE)\nsd_tr_age <- sd(train$age, na.rm = TRUE)\n\nmu_tr_glucose; sd_tr_glucose\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 122.2902\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 30.25447\n```\n\n\n:::\n\n```{.r .cell-code}\nmu_tr_age; sd_tr_age\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 33.1759\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 11.81636\n```\n\n\n:::\n:::\n\n\n### 3.3. Scale train and test using training statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_scaled <- train %>%\n  mutate(\n    glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,\n    age_scaled     = (age - mu_tr_age)     / sd_tr_age\n  )\n\ntest_scaled <- test %>%\n  mutate(\n    glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,\n    age_scaled     = (age - mu_tr_age)     / sd_tr_age\n  )\n\nhead(train_scaled)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    age glucose pedigree glucose_scaled age_scaled\n415  21     138    0.534      0.5192568 -1.0304267\n463  39      74    0.705     -1.5961334  0.4928847\n179  47     143    0.190      0.6845216  1.1699120\n526  21      87    0.444     -1.1664448 -1.0304267\n195  42      85    0.136     -1.2325507  0.7467699\n118  25      78    0.654     -1.4639215 -0.6919131\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(test_scaled)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   age glucose pedigree glucose_scaled  age_scaled\n1   50     148    0.627      0.8497865  1.42379718\n3   32     183    0.672      2.0066404 -0.09951419\n9   53     197    0.158      2.4693820  1.67768241\n17  31     118    0.551     -0.1418027 -0.18414260\n22  50      99    0.388     -0.7698091  1.42379718\n27  43     147    0.257      0.8167335  0.83139832\n```\n\n\n:::\n:::\n\n\n### 3.4. Fit linear regression model and compute MAE (RIGHT)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nped_model <- linear_reg() %>%\n  set_engine(\"lm\")\n\nfit_right <- ped_model %>%\n  fit(pedigree ~ age_scaled + glucose_scaled, data = train_scaled)\n\nresults_right <- predict(fit_right, new_data = test_scaled) %>%\n  bind_cols(test_scaled)\n\nmae_right <- mae(\n  data    = results_right,\n  truth   = pedigree,\n  estimate = .pred\n)\n\nmae_right\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 mae     standard       0.234\n```\n\n\n:::\n:::\n\n\n## 4. Comparing MAE: leaky vs leak-free\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntibble(\n  pipeline = c(\"WRONG: scaled before split (leakage)\",\n               \"RIGHT: scaled using training only\"),\n  MAE = c(mae_wrong$.estimate,\n          mae_right$.estimate)\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  pipeline                               MAE\n  <chr>                                <dbl>\n1 WRONG: scaled before split (leakage) 0.234\n2 RIGHT: scaled using training only    0.234\n```\n\n\n:::\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}