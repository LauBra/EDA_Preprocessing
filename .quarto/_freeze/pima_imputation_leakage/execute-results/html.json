{
  "hash": "ed705311140db561e0c4749090ad373c",
  "result": {
    "engine": "knitr",
    "markdown": "\n---\ntitle: \"Pima Imputation → Leak vs Leak-free (R)\"\nformat:\n  html:\n    toc: true\n    code-fold: true\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(tidymodels)\n\ntheme_set(theme_minimal())\nset.seed(123)\n```\n:::\n\n\n## Imputation leakage with insulin (no scaling)\n\nWe now look at **mean imputation of `insulin`**:\n\n- **Outcome**: `pedigree`\n- **Predictors**: `age`, `insulin_imp`\n- We compare:\n  - ❌ **WRONG**: mean for imputation computed using **all data** (leakage)\n  - ✅ **RIGHT**: mean for imputation computed using **training data only**\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"PimaIndiansDiabetes2\", package = \"mlbench\")\n\npima_imp <- PimaIndiansDiabetes2 %>%\n  clean_names() %>%\n  select(age, insulin, pedigree) %>%\n  filter(!is.na(pedigree))  # outcome must be present\n\nsummary(pima_imp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      age           insulin          pedigree     \n Min.   :21.00   Min.   : 14.00   Min.   :0.0780  \n 1st Qu.:24.00   1st Qu.: 76.25   1st Qu.:0.2437  \n Median :29.00   Median :125.00   Median :0.3725  \n Mean   :33.24   Mean   :155.55   Mean   :0.4719  \n 3rd Qu.:41.00   3rd Qu.:190.00   3rd Qu.:0.6262  \n Max.   :81.00   Max.   :846.00   Max.   :2.4200  \n                 NA's   :374                      \n```\n\n\n:::\n:::\n\n\n### 1. WRONG pipeline: impute using global mean (leakage)\n\nHere we:\n\n1. Compute the **global mean insulin** using all rows.\n2. Impute missing insulin values with this global mean.\n3. Then split into train/test.\n4. Fit `pedigree ~ age + insulin_imp` and evaluate MAE.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1. Global mean (leaky: uses all data)\nmean_all_insulin <- mean(pima_imp$insulin, na.rm = TRUE)\nmean_all_insulin\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 155.5482\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 2. Impute WHOLE dataset with global mean (before splitting)\npima_imp_wrong <- pima_imp %>%\n  mutate(\n    insulin_imp = ifelse(is.na(insulin), mean_all_insulin, insulin)\n  )\n\nsummary(pima_imp_wrong$insulin_imp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   14.0   121.5   155.5   155.5   155.5   846.0 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 3. Train–test split AFTER imputation (still leaky)\nset.seed(123)\nsplit_wrong <- initial_split(pima_imp_wrong, prop = 0.7)\n\ntrain_wrong <- training(split_wrong)\ntest_wrong  <- testing(split_wrong)\n\nnrow(train_wrong); nrow(test_wrong)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 537\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 231\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 4. Fit linear regression and compute MAE (WRONG)\nped_model <- linear_reg() %>%\n  set_engine(\"lm\")\n\nfit_wrong_imp <- ped_model %>%\n  fit(pedigree ~ age + insulin_imp, data = train_wrong)\n\ntidy(fit_wrong_imp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept) 0.369     0.0487       7.57  1.60e-13\n2 age         0.00115   0.00126      0.912 3.62e- 1\n3 insulin_imp 0.000467  0.000172     2.72  6.75e- 3\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresults_wrong_imp <- predict(fit_wrong_imp, new_data = test_wrong) %>%\n  bind_cols(test_wrong)\n\nmae_wrong_imp <- mae(\n  data     = results_wrong_imp,\n  truth    = pedigree,\n  estimate = .pred\n)\n\nmae_wrong_imp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 mae     standard       0.235\n```\n\n\n:::\n:::\n\n\n---\n\n### 2. RIGHT pipeline: impute using training mean only (no leakage)\n\nNow we:\n\n1. Split the **original (unimputed)** data into train/test.\n2. Compute mean insulin **using training data only**.\n3. Impute train and test using this **training mean**.\n4. Fit the same model and compute MAE.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1. Train–test split on RAW data\nset.seed(123)\nsplit_right <- initial_split(pima_imp, prop = 0.7)\n\ntrain_right <- training(split_right)\ntest_right  <- testing(split_right)\n\nnrow(train_right); nrow(test_right)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 537\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 231\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 2. Training-only mean for insulin (correct)\nmean_tr_insulin <- mean(train_right$insulin, na.rm = TRUE)\nmean_tr_insulin\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 155.3705\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 3. Impute train and test using TRAIN mean\ntrain_right_imp <- train_right %>%\n  mutate(\n    insulin_imp = ifelse(is.na(insulin), mean_tr_insulin, insulin)\n  )\n\ntest_right_imp <- test_right %>%\n  mutate(\n    insulin_imp = ifelse(is.na(insulin), mean_tr_insulin, insulin)\n  )\n\nsummary(train_right_imp$insulin_imp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   14.0   120.0   155.4   155.4   155.4   846.0 \n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(test_right_imp$insulin_imp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   15.0   125.5   155.4   155.7   155.4   600.0 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 4. Fit linear regression and compute MAE (RIGHT)\nfit_right_imp <- ped_model %>%\n  fit(pedigree ~ age + insulin_imp, data = train_right_imp)\n\ntidy(fit_right_imp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 5\n  term        estimate std.error statistic  p.value\n  <chr>          <dbl>     <dbl>     <dbl>    <dbl>\n1 (Intercept) 0.369     0.0487       7.57  1.60e-13\n2 age         0.00115   0.00126      0.912 3.62e- 1\n3 insulin_imp 0.000468  0.000172     2.72  6.68e- 3\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresults_right_imp <- predict(fit_right_imp, new_data = test_right_imp) %>%\n  bind_cols(test_right_imp)\n\nmae_right_imp <- mae(\n  data     = results_right_imp,\n  truth    = pedigree,\n  estimate = .pred\n)\n\nmae_right_imp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 mae     standard       0.235\n```\n\n\n:::\n:::\n\n\n---\n\n### 3. Compare MAE: imputation with vs without leakage\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntibble(\n  pipeline = c(\"WRONG: impute with global mean (leakage)\",\n               \"RIGHT: impute with training mean only\"),\n  MAE = c(mae_wrong_imp$.estimate,\n          mae_right_imp$.estimate)\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 2\n  pipeline                                   MAE\n  <chr>                                    <dbl>\n1 WRONG: impute with global mean (leakage) 0.235\n2 RIGHT: impute with training mean only    0.235\n```\n\n\n:::\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}