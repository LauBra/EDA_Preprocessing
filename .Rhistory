fit(pedigree ~ age_lt30 + age_30_60 + age_gt60 + diabetes_pos + insulin_log + pregnant_z + glucose_z + triceps_z , data = train)
test_pred <- predict(los_fit, test) %>%
bind_cols(test)
mae(test_pred, truth = pedigree, estimate = .pred)
print(los_fit)
split <- initial_split(pima_imputed_transformed_final,prop =0.7 )
train <- training(split)
test  <- testing(split)
los_model <- linear_reg() %>%
set_engine("lm")
los_fit <- los_model %>%
fit(pedigree ~ age_lt30 + age_30_60 + age_gt60 + diabetes_pos + insulin_log + pregnant_z + glucose_z + triceps_z , data = train)
test_pred <- predict(los_fit, test) %>%
bind_cols(test)
mae(test_pred, truth = pedigree, estimate = .pred)
print(los_fit)
View(PimaIndiansDiabetes2)
pima_small_scaled <- pima_small %>%
mutate(insulin_scaled = (insulin - mean_all_ins) / sd_all_ins)
data("PimaIndiansDiabetes2", package = "mlbench")
pima_small <- PimaIndiansDiabetes2 %>%
clean_names() %>%
select(age, glucose, pedigree) %>%
filter(!is.na(pedigree))  # outcome must be present
head(pima_small)
mean_all_ins <- mean(pima_small$glucose, na.rm = TRUE)
sd_all_ins <- sd(  pima_small$glucose, na.rm = TRUE)
mean_all_age <- mean(pima_small$age, na.rm = TRUE)
sd_all_age <- sd(  pima_small$age, na.rm = TRUE)
pima_small_scaled <- pima_small %>%
mutate(insulin_scaled = (insulin - mean_all_ins) / sd_all_ins)
ped_model <- linear_reg() %>%
set_engine("lm")
fit_wrong <- ped_model %>%
fit(pedigree ~ age_scaled + glucose_scaled, data = train)
mean_all_glucose <- mean(pima_small$glucose, na.rm = TRUE)
sd_all_glucose <- sd(  pima_small$glucose, na.rm = TRUE)
mean_all_age <- mean(pima_small$age, na.rm = TRUE)
sd_all_age <- sd(  pima_small$age, na.rm = TRUE)
pima_small_scaled <- pima_small %>%
mutate(glucose_scaled = (glucose - mean_all_glucose) / sd_all_glucose,
age_scaled = (age - mean_all_age) / sd_all_age
)
set.seed(123)
data_split <- initial_split(pima_small_scaled, prop = 0.7)
train <- training(data_split)
test  <- testing(data_split)
ped_model <- linear_reg() %>%
set_engine("lm")
fit_wrong <- ped_model %>%
fit(pedigree ~ age_scaled + glucose_scaled, data = train)
results_wrong <- predict(fit_wrong, new_data = test) %>%
bind_cols(test)  # adds .pred alongside pedigree
mae_wrong <- mae(results_wrong,
truth = pedigree,
estimate = .pred)
mae_wrong
train_scaled <- train %>%
mutate(glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled = (age - mu_tr_age) / sd_tr_age
)
test_scaled <- test %>%
mutate(glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled = (age - mu_tr_age) / sd_tr_age
)
mu_tr_glucose  <- mean(train$glucose, na.rm = TRUE)
sd_tr_glucose  <- sd(train$glucose, na.rm = TRUE)
mu_tr_age  <- mean(train$age, na.rm = TRUE)
sd_tr_age <- sd(train$age, na.rm = TRUE)
train_scaled <- train %>%
mutate(glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled = (age - mu_tr_age) / sd_tr_age
)
test_scaled <- test %>%
mutate(glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled = (age - mu_tr_age) / sd_tr_age
)
ped_model <- linear_reg() %>%
set_engine("lm")
fit_right <- ped_model %>%
fit(pedigree ~ age_scaled + glucose_scaled, data = train)
results_right <- predict(fit_right, new_data = test) %>%
bind_cols(test)  # adds .pred alongside pedigree
mae_right <- mae(results_right,
truth = pedigree,
estimate = .pred)
mae_right
library(tidyverse)
library(janitor)
library(tidymodels)
theme_set(theme_minimal())
set.seed(123)
data("PimaIndiansDiabetes2", package = "mlbench")
pima_small <- PimaIndIndiansDiabetes2 %>%
clean_names() %>%
select(age, glucose, pedigree) %>%
filter(!is.na(pedigree))  # outcome must be present
data("PimaIndiansDiabetes2", package = "mlbench")
pima_small <- PimaIndIndiansDiabetes2 %>%
clean_names() %>%
select(age, glucose, pedigree) %>%
filter(!is.na(pedigree))  # outcome must be present
data("PimaIndiansDiabetes2", package = "mlbench")
pima_small <- PimaIndiansDiabetes2 %>%
clean_names() %>%
select(age, glucose, pedigree) %>%
filter(!is.na(pedigree))  # outcome must be present
head(pima_small)
summary(pima_small)
library(tidyverse)
library(janitor)
library(tidymodels)
theme_set(theme_minimal())
set.seed(123)
data("PimaIndiansDiabetes2", package = "mlbench")
pima_small <- PimaIndiansDiabetes2 %>%
clean_names() %>%
select(age, glucose, pedigree) %>%
filter(!is.na(pedigree))  # outcome must be present
head(pima_small)
summary(pima_small)
mean_all_glucose <- mean(pima_small$glucose, na.rm = TRUE)
sd_all_glucose   <- sd(pima_small$glucose, na.rm = TRUE)
mean_all_age <- mean(pima_small$age, na.rm = TRUE)
sd_all_age   <- sd(pima_small$age, na.rm = TRUE)
mean_all_glucose; sd_all_glucose
mean_all_age; sd_all_age
pima_small_scaled <- pima_small %>%
mutate(
glucose_scaled = (glucose - mean_all_glucose) / sd_all_glucose,
age_scaled     = (age - mean_all_age) / sd_all_age
)
head(pima_small_scaled)
set.seed(123)
data_split <- initial_split(pima_small_scaled, prop = 0.7)
train <- training(data_split)
test  <- testing(data_split)
nrow(train); nrow(test)
ped_model <- linear_reg() %>%
set_engine("lm")
fit_wrong <- ped_model %>%
fit(pedigree ~ age_scaled + glucose_scaled, data = train)
results_wrong <- predict(fit_wrong, new_data = test) %>%
bind_cols(test)
mae_wrong <- mae(
data    = results_wrong,
truth   = pedigree,
estimate = .pred
)
mae_wrong
set.seed(123)
data_split_right <- initial_split(pima_small, prop = 0.7)
train <- training(data_split_right)
test  <- testing(data_split_right)
nrow(train); nrow(test)
mu_tr_glucose <- mean(train$glucose, na.rm = TRUE)
sd_tr_glucose <- sd(train$glucose, na.rm = TRUE)
mu_tr_age <- mean(train$age, na.rm = TRUE)
sd_tr_age <- sd(train$age, na.rm = TRUE)
mu_tr_glucose; sd_tr_glucose
mu_tr_age; sd_tr_age
train_scaled <- train %>%
mutate(
glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled     = (age - mu_tr_age)     / sd_tr_age
)
test_scaled <- test %>%
mutate(
glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled     = (age - mu_tr_age)     / sd_tr_age
)
head(train_scaled)
head(test_scaled)
ped_model <- linear_reg() %>%
set_engine("lm")
fit_right <- ped_model %>%
fit(pedigree ~ age_scaled + glucose_scaled, data = train_scaled)
results_right <- predict(fit_right, new_data = test_scaled) %>%
bind_cols(test_scaled)
mae_right <- mae(
data    = results_right,
truth   = pedigree,
estimate = .pred
)
mae_right
tibble(
pipeline = c("WRONG: scaled before split (leakage)",
"RIGHT: scaled using training only"),
MAE = c(mae_wrong$.estimate,
mae_right$.estimate)
)
set.seed(123)
data_split_right <- initial_split(pima_small, prop = 0.6)
train <- training(data_split_right)
test  <- testing(data_split_right)
nrow(train); nrow(test)
mu_tr_glucose <- mean(train$glucose, na.rm = TRUE)
sd_tr_glucose <- sd(train$glucose, na.rm = TRUE)
mu_tr_age <- mean(train$age, na.rm = TRUE)
sd_tr_age <- sd(train$age, na.rm = TRUE)
mu_tr_glucose; sd_tr_glucose
mu_tr_age; sd_tr_age
set.seed(123)
data_split_right <- initial_split(pima_small, prop = 0.9)
train <- training(data_split_right)
test  <- testing(data_split_right)
nrow(train); nrow(test)
mu_tr_glucose <- mean(train$glucose, na.rm = TRUE)
sd_tr_glucose <- sd(train$glucose, na.rm = TRUE)
mu_tr_age <- mean(train$age, na.rm = TRUE)
sd_tr_age <- sd(train$age, na.rm = TRUE)
mu_tr_glucose; sd_tr_glucose
mu_tr_age; sd_tr_age
set.seed(123)
data_split_right <- initial_split(pima_small, prop = 0.8)
train <- training(data_split_right)
test  <- testing(data_split_right)
nrow(train); nrow(test)
mu_tr_glucose <- mean(train$glucose, na.rm = TRUE)
sd_tr_glucose <- sd(train$glucose, na.rm = TRUE)
mu_tr_age <- mean(train$age, na.rm = TRUE)
sd_tr_age <- sd(train$age, na.rm = TRUE)
mu_tr_glucose; sd_tr_glucose
mu_tr_age; sd_tr_age
mu_tr_age <- mean(train$mass, na.rm = TRUE)
mu_tr_age
library(tidyverse)
library(janitor)
library(tidymodels)
theme_set(theme_minimal())
set.seed(123)
data("PimaIndiansDiabetes2", package = "mlbench")
pima_imp <- PimaIndiansDiabetes2 %>%
clean_names() %>%
select(age, insulin, pedigree) %>%
filter(!is.na(pedigree))  # outcome must be present
summary(pima_imp)
# 1. Global mean (leaky: uses all data)
mean_all_insulin <- mean(pima_imp$insulin, na.rm = TRUE)
mean_all_insulin
# 2. Impute WHOLE dataset with global mean (before splitting)
pima_imp_wrong <- pima_imp %>%
mutate(
insulin_imp = ifelse(is.na(insulin), mean_all_insulin, insulin)
)
summary(pima_imp_wrong$insulin_imp)
# 3. Train–test split AFTER imputation (still leaky)
set.seed(123)
split_wrong <- initial_split(pima_imp_wrong, prop = 0.7)
train_wrong <- training(split_wrong)
test_wrong  <- testing(split_wrong)
nrow(train_wrong); nrow(test_wrong)
# 4. Fit linear regression and compute MAE (WRONG)
ped_model <- linear_reg() %>%
set_engine("lm")
fit_wrong_imp <- ped_model %>%
fit(pedigree ~ age + insulin_imp, data = train_wrong)
tidy(fit_wrong_imp)
results_wrong_imp <- predict(fit_wrong_imp, new_data = test_wrong) %>%
bind_cols(test_wrong)
mae_wrong_imp <- mae(
data     = results_wrong_imp,
truth    = pedigree,
estimate = .pred
)
mae_wrong_imp
# 1. Train–test split on RAW data
set.seed(123)
split_right <- initial_split(pima_imp, prop = 0.7)
train_right <- training(split_right)
test_right  <- testing(split_right)
nrow(train_right); nrow(test_right)
# 2. Training-only mean for insulin (correct)
mean_tr_insulin <- mean(train_right$insulin, na.rm = TRUE)
mean_tr_insulin
# 3. Impute train and test using TRAIN mean
train_right_imp <- train_right %>%
mutate(
insulin_imp = ifelse(is.na(insulin), mean_tr_insulin, insulin)
)
test_right_imp <- test_right %>%
mutate(
insulin_imp = ifelse(is.na(insulin), mean_tr_insulin, insulin)
)
summary(train_right_imp$insulin_imp)
summary(test_right_imp$insulin_imp)
# 4. Fit linear regression and compute MAE (RIGHT)
fit_right_imp <- ped_model %>%
fit(pedigree ~ age + insulin_imp, data = train_right_imp)
tidy(fit_right_imp)
results_right_imp <- predict(fit_right_imp, new_data = test_right_imp) %>%
bind_cols(test_right_imp)
mae_right_imp <- mae(
data     = results_right_imp,
truth    = pedigree,
estimate = .pred
)
mae_right_imp
tibble(
pipeline = c("WRONG: impute with global mean (leakage)",
"RIGHT: impute with training mean only"),
MAE = c(mae_wrong_imp$.estimate,
mae_right_imp$.estimate)
)
library(tidyverse)
library(janitor)
library(tidymodels)
theme_set(theme_minimal())
set.seed(123)
data("PimaIndiansDiabetes2", package = "mlbench")
pima_base <- PimaIndiansDiabetes2 %>%
clean_names() %>%
select(age, glucose, insulin, pedigree) %>%
filter(!is.na(pedigree))  # outcome must be present
head(pima_base)
summary(pima_base)
pima_small <- pima_base %>%
select(age, glucose, pedigree)
# Global means and sds (leaky: use all rows)
mean_all_glucose <- mean(pima_small$glucose, na.rm = TRUE)
sd_all_glucose   <- sd(  pima_small$glucose, na.rm = TRUE)
mean_all_age <- mean(pima_small$age, na.rm = TRUE)
sd_all_age   <- sd(  pima_small$age, na.rm = TRUE)
mean_all_glucose; sd_all_glucose
mean_all_age; sd_all_age
# Scale entire dataset with global stats
pima_small_scaled <- pima_small %>%
mutate(
glucose_scaled = (glucose - mean_all_glucose) / sd_all_glucose,
age_scaled     = (age     - mean_all_age)     / sd_all_age
)
head(pima_small_scaled)
# Train–test split AFTER scaling (still leaky)
set.seed(123)
data_split_wrong <- initial_split(pima_small_scaled, prop = 0.7)
train_wrong <- training(data_split_wrong)
test_wrong  <- testing(data_split_wrong)
nrow(train_wrong); nrow(test_wrong)
# Linear regression with tidymodels
ped_model <- linear_reg() %>%
set_engine("lm")
fit_wrong <- ped_model %>%
fit(pedigree ~ age_scaled + glucose_scaled, data = train_wrong)
tidy(fit_wrong)
results_wrong <- predict(fit_wrong, new_data = test_wrong) %>%
bind_cols(test_wrong)
mae_wrong <- mae(
data     = results_wrong,
truth    = pedigree,
estimate = .pred
)
mae_wrong
# Train–test split on original (unscaled) data
set.seed(123)
data_split_right <- initial_split(pima_small, prop = 0.7)
train_right <- training(data_split_right)
test_right  <- testing(data_split_right)
nrow(train_right); nrow(test_right)
# Training-only statistics (correct)
mu_tr_glucose <- mean(train_right$glucose, na.rm = TRUE)
sd_tr_glucose <- sd(  train_right$glucose, na.rm = TRUE)
mu_tr_age <- mean(train_right$age, na.rm = TRUE)
sd_tr_age <- sd(  train_right$age, na.rm = TRUE)
mu_tr_glucose; sd_tr_glucose
mu_tr_age; sd_tr_age
# Scale train and test using TRAIN stats
train_scaled <- train_right %>%
mutate(
glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled     = (age     - mu_tr_age)     / sd_tr_age
)
test_scaled <- test_right %>%
mutate(
glucose_scaled = (glucose - mu_tr_glucose) / sd_tr_glucose,
age_scaled     = (age     - mu_tr_age)     / sd_tr_age
)
head(train_scaled)
head(test_scaled)
fit_right <- ped_model %>%
fit(pedigree ~ age_scaled + glucose_scaled, data = train_scaled)
tidy(fit_right)
results_right <- predict(fit_right, new_data = test_scaled) %>%
bind_cols(test_scaled)
mae_right <- mae(
data     = results_right,
truth    = pedigree,
estimate = .pred
)
mae_right
tibble(
pipeline = c("WRONG: scaled before split (leakage)",
"RIGHT: scaled using training only"),
MAE = c(mae_wrong$.estimate,
mae_right$.estimate)
)
pima_imp <- pima_base %>%
select(age, insulin, pedigree)
summary(pima_imp)
# Global mean (leaky)
mean_all_insulin <- mean(pima_imp$insulin, na.rm = TRUE)
mean_all_insulin
# Impute whole dataset before splitting
pima_imp_wrong <- pima_imp %>%
mutate(
insulin_imp = ifelse(is.na(insulin), mean_all_insulin, insulin)
)
summary(pima_imp_wrong$insulin_imp)
set.seed(123)
split_wrong_imp <- initial_split(pima_imp_wrong, prop = 0.7)
train_wrong_imp <- training(split_wrong_imp)
test_wrong_imp  <- testing(split_wrong_imp)
nrow(train_wrong_imp); nrow(test_wrong_imp)
fit_wrong_imp <- ped_model %>%
fit(pedigree ~ age + insulin_imp, data = train_wrong_imp)
tidy(fit_wrong_imp)
results_wrong_imp <- predict(fit_wrong_imp, new_data = test_wrong_imp) %>%
bind_cols(test_wrong_imp)
mae_wrong_imp <- mae(
data     = results_wrong_imp,
truth    = pedigree,
estimate = .pred
)
mae_wrong_imp
set.seed(123)
split_right_imp <- initial_split(pima_imp, prop = 0.7)
train_right_imp <- training(split_right_imp)
test_right_imp  <- testing(split_right_imp)
nrow(train_right_imp); nrow(test_right_imp)
mean_tr_insulin <- mean(train_right_imp$insulin, na.rm = TRUE)
mean_tr_insulin
train_right_imp2 <- train_right_imp %>%
mutate(
insulin_imp = ifelse(is.na(insulin), mean_tr_insulin, insulin)
)
test_right_imp2 <- test_right_imp %>%
mutate(
insulin_imp = ifelse(is.na(insulin), mean_tr_insulin, insulin)
)
summary(train_right_imp2$insulin_imp)
summary(test_right_imp2$insulin_imp)
fit_right_imp <- ped_model %>%
fit(pedigree ~ age + insulin_imp, data = train_right_imp2)
tidy(fit_right_imp)
results_right_imp <- predict(fit_right_imp, new_data = test_right_imp2) %>%
bind_cols(test_right_imp2)
mae_right_imp <- mae(
data     = results_right_imp,
truth    = pedigree,
estimate = .pred
)
mae_right_imp
tibble(
pipeline = c("WRONG: impute with global mean (leakage)",
"RIGHT: impute with training mean only"),
MAE = c(mae_wrong_imp$.estimate,
mae_right_imp$.estimate)
)
pima_rec <- pima_base %>%
select(age, glucose, insulin, pedigree)
set.seed(123)
rec_split <- initial_split(pima_rec, prop = 0.7)
pima_train <- training(rec_split)
pima_test  <- testing(rec_split)
pima_train %>% head()
# Recipe: impute + scale all predictors
ped_recipe <- recipe(pedigree ~ age + glucose + insulin, data = pima_train) %>%
step_impute_mean(all_predictors()) %>%
step_normalize(all_predictors())
ped_recipe
ped_model_rec <- linear_reg() %>%
set_engine("lm")
ped_wf <- workflow() %>%
add_model(ped_model_rec) %>%
add_recipe(ped_recipe)
ped_wf
# Fit on TRAIN, evaluate on TEST
final_fit <- last_fit(
ped_wf,
split   = rec_split,
metrics = metric_set(mae)
)
collect_metrics(final_fit)
# Optional: inspect the baked design matrix
prepped_recipe <- prep(ped_recipe)
baked_train <- bake(prepped_recipe, new_data = pima_train)
baked_test  <- bake(prepped_recipe, new_data = pima_test)
head(baked_train)
library(reticulate)
# one-off setup (if you haven't done it yet)
# install_miniconda()
##conda_create(
##  envname = "hds-python",
##  python_version = "3.11",
##  packages = c("numpy", "pandas", "matplotlib", "seaborn", "scikit-learn")
##)
use_condaenv("hds-python", required = TRUE)
#py_config()
#conda_install("hds-python", c("jupyter", "plotly"))
reticulate::repl_python()
mae_manual
library(reticulate)
# one-off setup (if you haven't done it yet)
# install_miniconda()
##conda_create(
##  envname = "hds-python",
##  python_version = "3.11",
##  packages = c("numpy", "pandas", "matplotlib", "seaborn", "scikit-learn")
##)
use_condaenv("hds-python", required = TRUE)
#py_config()
#conda_install("hds-python", c("jupyter", "plotly"))
reticulate::repl_python()
